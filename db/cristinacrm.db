PRAGMA foreign_keys = 1;
PRAGMA journal_mode = WAL;

CREATE TABLE users (
    id              TEXT PRIMARY KEY,          -- UUID v7
    email           TEXT UNIQUE NOT NULL,
    phone           TEXT,
    locale          TEXT DEFAULT 'es',
    created_at      TEXT DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ')),
    updated_at      TEXT DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ')),
    deleted_at      TEXT
);

CREATE TABLE leads (
    id              TEXT PRIMARY KEY,
    user_id         TEXT NOT NULL REFERENCES users(id),
    full_name       TEXT NOT NULL,
    status          TEXT CHECK (status IN ('new','pending','enrolled','dropped')) DEFAULT 'new',
    available_slots TEXT,                     -- JSON array
    comments        TEXT,
    created_at      TEXT DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ')),
    updated_at      TEXT,
    deleted_at      TEXT
);

CREATE TABLE appointments (
    id              TEXT PRIMARY KEY,
    lead_id         TEXT NOT NULL REFERENCES leads(id),
    start_at        TEXT NOT NULL,
    attended        INTEGER CHECK (attended IN (0,1)) DEFAULT 0,
    outcome         TEXT CHECK (outcome IN ('noshow','interested','not_interested','pending')) DEFAULT 'pending',
    comments        TEXT,
    created_at      TEXT DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ'))
);

CREATE TABLE sessions (
    id              TEXT PRIMARY KEY,
    lead_id         TEXT NOT NULL REFERENCES leads(id),
    coach_id        TEXT NOT NULL,
    start_at        TEXT NOT NULL,
    type            TEXT CHECK (type IN ('first','30d','90d','extra')) DEFAULT 'first',
    comments        TEXT,
    created_at      TEXT DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ'))
);

CREATE TABLE feedback (
    id              TEXT PRIMARY KEY,
    session_id      TEXT NOT NULL REFERENCES sessions(id),
    score           INTEGER CHECK (score BETWEEN 1 AND 5),
    comments        TEXT,
    created_at      TEXT DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ'))
);

CREATE TABLE coaches (
    id              TEXT PRIMARY KEY,
    full_name       TEXT NOT NULL,
    email           TEXT UNIQUE NOT NULL,
    active          INTEGER DEFAULT 1
);

CREATE TABLE credentials (
    user_id     TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    cred_id     TEXT UNIQUE NOT NULL,
    public_key  BLOB NOT NULL,
    counter     INTEGER NOT NULL,
    transports  TEXT NOT NULL,
    created_at  TEXT DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ')),
    PRIMARY KEY (user_id, cred_id)
);